/**
 * This ruleset enforces a strict user-ownership model for a personal portfolio application.
 *
 * Core Philosophy:
 * All user data is private and can only be accessed by the authenticated owner. This ensures
 * data privacy and security by default.
 *
 * Data Structure:
 * The entire data model is hierarchical, with all user-specific content nested under the path
 * `/users/{userId}`. A user's main profile is at `/users/{userId}/profiles/{profileId}`,
 * with related data like metrics, links, and tech stack items stored in subcollections.
 *
 * Key Security Decisions:
 * - Public Read, Private Write: Content under a user's profile is publicly readable (`get`, `list`)
 *   to allow any visitor to see the portfolio. However, write operations (`create`, `update`, `delete`)
 *   are strictly limited to the authenticated owner of that data.
 * - No User Listing: It is not possible to list all documents in the top-level `/users` collection,
 *   preventing enumeration of all application users.
 * - Path-Based Security for Writes: Authorization for writes relies entirely on the document path,
 *   which is fast, cost-effective, and avoids complex cross-document reads (`get()` calls).
 * - Relational Integrity: On document creation, rules ensure that denormalized IDs (like `profileId`
 *   in subcollections) match the parent document's ID, and these IDs are immutable upon update.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing data ownership for writes.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * A robust check for update and delete operations.
     * Ensures the user is the owner AND the document actually exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * VALIDATION (CREATE): For a new Profile document, ensures the internal `id`
     * field matches the document's ID from the path.
     */
    function isCreatingProfileWithMatchingId(profileId) {
      return request.resource.data.id == profileId;
    }

    /**
     * VALIDATION (UPDATE): Enforces immutability of the Profile's `id` field.
     */
    function isProfileIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * VALIDATION (CREATE): For new subcollection items, ensures the denormalized
     * `profileId` field matches the parent Profile's ID from the path.
     */
    function isCreatingChildWithMatchingProfileId(profileId) {
      return request.resource.data.profileId == profileId;
    }

    /**
     * VALIDATION (UPDATE): Enforces immutability of a subcollection item's
     * `profileId` field, preventing it from being re-parented.
     */
    function isChildProfileIdImmutable() {
      return request.resource.data.profileId == resource.data.profileId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}/profiles/{profileId}
     * @allow Anyone can read profile data. Only the owner can write.
     * @deny A different user (uid: 'user_xyz') is denied write access to `/users/user_abc/profiles/profile_123`.
     * @principle Public read access for portfolio display, ownership-restricted writes for CMS.
     */
    match /users/{userId}/profiles/{profileId} {
      allow get: if true;
      allow list: if true;
      allow create: if isOwner(userId) && isCreatingProfileWithMatchingId(profileId);
      allow update: if isExistingOwner(userId) && isProfileIdImmutable();
      allow delete: if isExistingOwner(userId);

      /**
       * @description Manages key metrics for a user's profile.
       * @path /users/{userId}/profiles/{profileId}/keyMetrics/{keyMetricId}
       * @allow Anyone can read key metrics. Only the owner can write.
       * @principle Enforces public read and owner-only writes, plus data consistency.
       */
      match /keyMetrics/{keyMetricId} {
        allow get: if true;
        allow list: if true;
        allow create: if isOwner(userId) && isCreatingChildWithMatchingProfileId(profileId);
        allow update: if isExistingOwner(userId) && isChildProfileIdImmutable();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages navigation links for a user's profile.
       * @path /users/{userId}/profiles/{profileId}/navigationLinks/{navigationLinkId}
       * @allow Anyone can read navigation links. Only the owner can write.
       * @principle Enforces public read and owner-only writes, plus data consistency.
       */
      match /navigationLinks/{navigationLinkId} {
        allow get: if true;
        allow list: if true;
        allow create: if isOwner(userId) && isCreatingChildWithMatchingProfileId(profileId);
        allow update: if isExistingOwner(userId) && isChildProfileIdImmutable();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages tech stack items for a user's profile.
       * @path /users/{userId}/profiles/{profileId}/techStackItems/{techStackItemId}
       * @allow Anyone can read tech stack items. Only the owner can write.
       * @principle Enforces public read and owner-only writes, plus data consistency.
       */
      match /techStackItems/{techStackItemId} {
        allow get: if true;
        allow list: if true;
        allow create: if isOwner(userId) && isCreatingChildWithMatchingProfileId(profileId);
        allow update: if isExistingOwner(userId) && isChildProfileIdImmutable();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages contact methods for a user's profile.
       * @path /users/{userId}/profiles/{profileId}/contactMethods/{contactMethodId}
       * @allow Anyone can read contact methods. Only the owner can write.
       * @principle Enforces public read and owner-only writes, plus data consistency.
       */
      match /contactMethods/{contactMethodId} {
        allow get: if true;
        allow list: if true;
        allow create: if isOwner(userId) && isCreatingChildWithMatchingProfileId(profileId);
        allow update: if isExistingOwner(userId) && isChildProfileIdImmutable();
        allow delete: if isExistingOwner(userId);
      }
    }
  }
}
